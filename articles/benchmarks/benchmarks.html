<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Benchmarks • vroom</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Benchmarks">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">vroom</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/benchmarks/benchmarks.html">Benchmarks</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jimhester/vroom">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Benchmarks</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jimhester/vroom/blob/master/vignettes/benchmarks/benchmarks.Rmd"><code>vignettes/benchmarks/benchmarks.Rmd</code></a></small>
      <div class="hidden name"><code>benchmarks.Rmd</code></div>

    </div>

    
    
<p>vroom is an experiment for a future version of readr (2.0), or a possible extension package.</p>
<p>It stems from the observation that IO is not the bottle neck in parsing delimited datasets, rather (re)-allocating memory and parsing the values into R data types (particularly for characters) takes the bulk of the time.</p>
<p>It relies on the Altrep framework available in R 3.5 to provide lazy / delayed parsing of values in delimited files.</p>
<div id="how-it-works" class="section level2">
<h2 class="hasAnchor">
<a href="#how-it-works" class="anchor"></a>How it works</h2>
<p>The initial reading of the file simply records the locations of each individual record, the actual values are not read into R. Altrep vectors are created for each column in the data which hold a pointer to the index and the memory mapped file. When these vectors are indexed the value is read from the memory mapping.</p>
<p>This means initial reading is extremely fast, in the example below it is ~ 1/4 the time of the multi-threaded <code>data.table::fread()</code>. Sampling operations are likewise extremely fast, as only the data actually included in the sample is read. This means things like the tibble print method, calling <code><a href="https://www.rdocumentation.org/packages/utils/topics/head">head()</a></code>, <code><a href="https://www.rdocumentation.org/packages/utils/topics/head">tail()</a></code> <code>x[sample(), ]</code> etc. have very low overhead.</p>
<p>Filtering also can be fast, only the columns included in the filter itself have to be fully read across the entire dataset, only the filtered rows need to be read from the remaining columns.</p>
<p>(<em>N.B. currently the dplyr implementation materializes the all numeric vectors when using <code><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter()</a></code> or <code>sample_n()</code>, so these cases are not as fast as they could otherwise be</em>).</p>
<p>This approach also allows you to work with data that is larger than memory. As long as you are careful to avoid materializing the entire dataset at once it can be efficiently queried and subset.</p>
<p>Once a particular vector is fully materialized the speed for all subsequent operations should be identical to a normal R vector.</p>
<p>There is also lots of possible speed improvements available. The indexer could be highly parallelized, as it does not rely on R data structures at all. The index could also be stored on disk, which would make re-reading the file at a later time basically instantaneous. Materializing non-character vectors could also be parallelized.</p>
</div>
<div id="dataset" class="section level2">
<h2 class="hasAnchor">
<a href="#dataset" class="anchor"></a>Dataset</h2>
<p>The dataset used in these benchmarks is from FOIA/FOILed Taxi Trip Data from the NYC Taxi and Limousine Commission 2013, originally posted at <a href="http://chriswhong.com/open-data/foil_nyc_taxi/" class="uri">http://chriswhong.com/open-data/foil_nyc_taxi/</a>. It is also hosted on <a href="https://archive.org/details/nycTaxiTripData2013">archive.org</a>.</p>
<p>The first table trip_fare_1.csv was converted to tsv and saved as trip_fare_1.tsv, It is 1.55G in size.</p>
<pre><code>#&gt; Observations: 14,776,615
#&gt; Variables: 11
#&gt; $ medallion       &lt;chr&gt; "89D227B655E5C82AECF13C3F540D4CF4", "0BD7C8F5B...
#&gt; $ hack_license    &lt;chr&gt; "BA96DE419E711691B9445D6A6307C170", "9FD8F69F0...
#&gt; $ vendor_id       &lt;chr&gt; "CMT", "CMT", "CMT", "CMT", "CMT", "CMT", "CMT...
#&gt; $ pickup_datetime &lt;chr&gt; "2013-01-01 15:11:48", "2013-01-06 00:18:35", ...
#&gt; $ payment_type    &lt;chr&gt; "CSH", "CSH", "CSH", "CSH", "CSH", "CSH", "CSH...
#&gt; $ fare_amount     &lt;dbl&gt; 6.5, 6.0, 5.5, 5.0, 9.5, 9.5, 6.0, 34.0, 5.5, ...
#&gt; $ surcharge       &lt;dbl&gt; 0.0, 0.5, 1.0, 0.5, 0.5, 0.0, 0.0, 0.0, 1.0, 0...
#&gt; $ mta_tax         &lt;dbl&gt; 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5, 0...
#&gt; $ tip_amount      &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0...
#&gt; $ tolls_amount    &lt;dbl&gt; 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 4.8, 0.0, 0...
#&gt; $ total_amount    &lt;dbl&gt; 7.0, 7.0, 7.0, 6.0, 10.5, 10.0, 6.5, 39.3, 7.0...</code></pre>
</div>
<div id="benchmarks" class="section level2">
<h2 class="hasAnchor">
<a href="#benchmarks" class="anchor"></a>Benchmarks</h2>
<p>The code used to run the benchmarks is in <a href="https://github.com/jimhester/vroom/blob/master/bench/benchmark.R">bench/benchmark.R</a>.</p>
<p>The benchmark <code>base</code> uses <code>vroom</code> with base functions for subsetting. <code>dplyr</code> uses <code>vroom</code> to read the file and dplyr functions to subset. <code>data.table</code> uses <code>fread()</code> to read the file and <code>data.table</code> functions to subset and <code>readr</code> uses <code>readr</code> to read the file and <code>dplyr</code> to subset.</p>
<p>The following operations are performed.</p>
<ul>
<li>The data is read</li>
<li>
<code><a href="https://www.rdocumentation.org/packages/base/topics/print">print()</a></code> - <em>N.B. read.delim uses <code><a href="https://www.rdocumentation.org/packages/base/topics/print">print(head(x, 25))</a></code> because printing the whole dataset takes &gt; 10 minutes</em>
</li>
<li><code><a href="https://www.rdocumentation.org/packages/utils/topics/head">head()</a></code></li>
<li><code><a href="https://www.rdocumentation.org/packages/utils/topics/head">tail()</a></code></li>
<li>Sampling 100 random rows</li>
<li>Filtering for “UNK” payment, this is 6434 rows (0.0435% of total).</li>
</ul>
<table class="table">
<thead><tr>
<th style="text-align:right;">
package
</th>
<th style="text-align:right;">
Time to read file
</th>
<th style="text-align:right;">
Total time for all operations (sec)
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
vroom_base
</td>
<td style="text-align:right;">
2.6s
</td>
<td style="text-align:right;">
5.3s
</td>
</tr>
<tr>
<td style="text-align:right;">
vroom_dplyr
</td>
<td style="text-align:right;">
2.6s
</td>
<td style="text-align:right;">
12.4s
</td>
</tr>
<tr>
<td style="text-align:right;">
data.table
</td>
<td style="text-align:right;">
19.7s
</td>
<td style="text-align:right;">
19.9s
</td>
</tr>
<tr>
<td style="text-align:right;">
readr
</td>
<td style="text-align:right;">
25.8s
</td>
<td style="text-align:right;">
26.2s
</td>
</tr>
<tr>
<td style="text-align:right;">
read.delim
</td>
<td style="text-align:right;">
1m 51.1s
</td>
<td style="text-align:right;">
1m 51.4s
</td>
</tr>
</tbody>
</table>
<p>Graph of timings, note because <code>vroom</code> and <code>data.table</code> operations use multiple cores the processor time is often much higher than the real time.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggplot2)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(forcats)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">tm_df <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">package =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/forcats/topics/fct_inorder">fct_inorder</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/grep">sub</a></span>(<span class="st">"_"</span>, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>, package))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span>(<span class="dt">y =</span> <span class="dv">0</span>, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> package, <span class="dt">xend =</span> package, <span class="dt">yend =</span> time, <span class="dt">alpha =</span> type), <span class="dt">color =</span> <span class="st">"grey50"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="st">    </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> package, <span class="dt">y =</span> time, <span class="dt">color =</span> type)) <span class="op">+</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="st">    </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span>(op), <span class="dt">scales =</span> <span class="st">"free"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="st">    </span>bench<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/bench/topics/scale_bench_time">scale_y_bench_time</a></span>(<span class="dt">base =</span> <span class="ot">NULL</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="st">    </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="dt">legend.position =</span> <span class="st">"bottom"</span>)</a></code></pre></div>
<p><img src="benchmarks_files/figure-html/unnamed-chunk-3-1.png" width="960"></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">sessioninfo<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/sessioninfo/topics/package_info">package_info</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"vroom"</span>, <span class="st">"readr"</span>, <span class="st">"dplyr"</span>, <span class="st">"data.table"</span>), <span class="dt">dependencies =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co">#&gt;  ! package    * version    date       lib source        </span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co">#&gt;  R data.table   &lt;NA&gt;       &lt;NA&gt;       [?] &lt;NA&gt;          </span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co">#&gt;    dplyr      * 0.7.8      2018-11-10 [1] CRAN (R 3.5.1)</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="co">#&gt;    readr        1.3.1      2018-12-21 [1] CRAN (R 3.5.1)</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="co">#&gt;    vroom        0.0.0.9000 2018-12-28 [1] local         </span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="co">#&gt; [1] /home/travis/R/Library</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="co">#&gt; [2] /usr/local/lib/R/site-library</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="co">#&gt; [3] /home/travis/R-bin/lib/R/library</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="co">#&gt;  R ── Package was removed from disk.</span></a></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#how-it-works">How it works</a></li>
      <li><a href="#dataset">Dataset</a></li>
      <li><a href="#benchmarks">Benchmarks</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Jim Hester.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
